services:
  dev:
    build:
      context: .
      dockerfile: Dockerfile

    volumes:
      # Named volume for source code (for Clone Sources mode)
      # JetBrains Gateway will clone the repo into this volume
      - koski-workspace:/workspace
      # Also bind mount to /var/lib/docker/volumes for docker-in-docker access
      - koski-workspace:/var/lib/docker/volumes/koski-workspace/_data:ro
      # Persist Maven cache
      - koski-maven-cache:/home/vscode/.m2
      # Forward SSH agent for git operations
      - type: bind
        source: ${SSH_AUTH_SOCK:-/run/host-services/ssh-auth.sock}
        target: /run/host-services/ssh-auth.sock

    # Overrides default command so things don't shut down after the process ends.
    command: sleep infinity

    # Expose ports for services (host network mode doesn't work on macOS)
    ports:
      - "7021:7021"
      - "5432:5432"
      - "9200:9200"
      - "8000:8000"
      - "4566:4566"

    # Increase shared memory size for browser operations
    shm_size: '2gb'

    # Add capabilities for browser support
    cap_add:
      - SYS_ADMIN

    security_opt:
      - seccomp:unconfined

    environment:
      # Display settings for headless browser
      - DISPLAY=:99
      # Playwright/Puppeteer settings
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
      # SSH agent forwarding
      - SSH_AUTH_SOCK=/run/host-services/ssh-auth.sock

  postgres:
    image: "postgres:15.2@sha256:78a275d4c891f7b3a33d3f1a78eda9f1d744954d9e20122bfdc97cdda25cddaf"
    command: "postgres -c max_connections=200 -c log_statement=all -c log_destination=stderr"
    environment:
      - "POSTGRES_USER=oph"
      - "POSTGRES_PASSWORD=oph"
      - "TZ=Europe/Helsinki"
    ports:
      - "5432:5432"
    volumes:
      - koski-devcontainer-postgres:/var/lib/postgresql/data

  opensearch:
    image: "opensearchproject/opensearch:2.11.1"
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - "discovery.type=single-node"
      - "plugins.security.disabled=true"
    ports:
      - "9200:9200"
    volumes:
      - koski-devcontainer-opensearch:/usr/share/opensearch/data

  dynamodb:
    image: "amazon/dynamodb-local:2.5.2@sha256:d7ebddeb60fa418bcda218a6c6a402a58441b2a20d54c9cb1d85fd5194341753"
    ports:
      - "8000:8000"
    volumes:
      - koski-devcontainer-dynamodb:/home/dynamodblocal/data

  localstack:
    image: "localstack/localstack:s3-latest-arm64@sha256:f507334401cd2e074ce57680a9863dd6e2c372aedb2c7829a45db242fda89611"
    ports:
      - "4566:4566"
      - "4510-4559:4510-4559"
    environment:
      - DEBUG=${DEBUG:-0}
    volumes:
      - koski-devcontainer-localstack:/var/lib/localstack

volumes:
  koski-workspace:
  koski-maven-cache:
  koski-devcontainer-postgres:
  koski-devcontainer-opensearch:
  koski-devcontainer-dynamodb:
  koski-devcontainer-localstack:
