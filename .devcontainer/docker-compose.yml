services:
  dev:
    build:
      context: .
      dockerfile: Dockerfile

    volumes:
      # Named volume for source code (for Clone Sources mode)
      # JetBrains Gateway will clone the repo into this volume
      - koski-workspace:/workspace
      # Persist Maven cache
      - koski-maven-cache:/home/vscode/.m2
      # Forward SSH agent for git operations
      - type: bind
        source: ${SSH_AUTH_SOCK:-/run/host-services/ssh-auth.sock}
        target: /run/host-services/ssh-auth.sock

    # Overrides default command so things don't shut down after the process ends.
    command: sleep infinity

    # Expose ports for services (host network mode doesn't work on macOS)
    ports:
      - "7021:7021"
      - "5432:5432"
      - "9200:9200"
      - "8000:8000"
      - "4566:4566"

    # Increase shared memory size for browser operations
    shm_size: '2gb'

    # Add capabilities for browser support
    cap_add:
      - SYS_ADMIN

    security_opt:
      - seccomp:unconfined

    environment:
      # Display settings for headless browser
      - DISPLAY=:99
      # Playwright/Puppeteer settings
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
      # SSH agent forwarding
      - SSH_AUTH_SOCK=/run/host-services/ssh-auth.sock

volumes:
  koski-workspace:
  koski-maven-cache:
