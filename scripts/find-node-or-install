#!/usr/bin/env bash
##############################################################################
# Finds the bin directory where node and npm are installed, or installs a
# local copy of them in a temp folder if not found. Then outputs where they
# are.
#
# Usage and install instructions:
# https://github.com/hugojosefson/find-node-or-install
##############################################################################

NODE_VERSION=${NODE_VERSION:-13.7.0}

# Creates temp dir which stays the same every time this script executes
function setTEMP_DIR()
{
  local NEW_OS_SUGGESTED_TEMP_FILE=$(mktemp -t asdXXXXX)
  local OS_ROOT_TEMP_DIR=$(dirname ${NEW_OS_SUGGESTED_TEMP_FILE})
  rm ${NEW_OS_SUGGESTED_TEMP_FILE}
  TEMP_DIR=${OS_ROOT_TEMP_DIR}/nvm
  mkdir -p ${TEMP_DIR}
}

# Break on error
set -e

# Try to find node, but don't break if not found
NODE=$(which node || true)

if [[ -n "${NODE}" ]]  && ! grep "find-node-or-install" "${NODE}" >/dev/null && [ $(${NODE} --version) == "v${NODE_VERSION}" ] >/dev/null; then
  # Good. We found it.
  echo $(dirname ${NODE})
else
  ROOT_DIR=$(pwd)

  # Did not find node. Better install it.
  # Do it in a temp dir, which stays the same every time this script executes
  setTEMP_DIR
  cd ${TEMP_DIR}

  # Do we have nvm here?
  if [[ ! -d "nvm" ]]; then
    cp ${ROOT_DIR}/scripts/nvm.sh ${TEMP_DIR}/nvm.sh >/dev/null
  fi

  # Clear and set NVM_* env variables to our installation
  mkdir -p .nvm
  export NVM_DIR=$( (cd .nvm && pwd) )
  unset NVM_PATH
  unset NVM_BIN

  # Load nvm into current shell
  . nvm.sh >/dev/null

  # Install and activate the requested version of node
  nvm install ${NODE_VERSION} >/dev/null

  # Find and output node's bin directory
  NODE=$(which node)
  echo $(dirname ${NODE})
fi
