name: Run security tests
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
env:
  DOCKER_BUILDKIT: 1

jobs:
  build:
    name: Build
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup_pnpm_cache

      - name: Run Trivy on Koski
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          exit-code: 1
          scanners: vuln
          trivyignores: .trivyignore
          format: json
          output: trivy-report.json
          severity: 'CRITICAL,HIGH'
          skip-dirs: 'src/main/resources/mockdata,src/test,target'

      - name: Summarize new CVEs
        if: failure()
        id: summarize
        run: |
          {
            echo 'cves<<EOF'
            jq -r '
              [.Results[]
               | select(.Vulnerabilities != null)
               | {target: .Target, vulns: [
                   .Vulnerabilities[]
                   | "- <\(.PrimaryURL)|\(.VulnerabilityID)> [\(.Severity)] (\(.PkgName) \(.InstalledVersion))"
                 ]}
              ]
              | group_by(.target)
              | .[]
              | (.[0].target),
                (map(.vulns) | add | unique | join("\n")),
                ""
            ' trivy-report.json
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Report to Slack
        if: failure()
        uses: ravsamhq/notify-slack-action@95a35215cdf7ab510d2cdd20ae94f342d212a1a1
        with:
          status: ${{ job.status }}
          message_format: |
            {emoji} *{workflow}* {status_message}

            *New vulnerabilities found* in <{repo_url}|{repo}>

            ${{ steps.summarize.outputs.cves }}

            <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|See full report in logs>
            <https://trivy.util.yleiskayttoiset.opintopolku.fi/koski.html|See current status (use vpn)>
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL_PROD_ALERTS }}

      - name: Run Trivy (full HTML report)
        if: always()
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          scanners: vuln
          format: table
          skip-dirs: 'src/main/resources/mockdata,src/test,target'
          exit-code: 0
